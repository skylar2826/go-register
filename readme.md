# go 服务注册与发现

![image-20250318145517872](服务注册与发现.assets/image-20250318145517872.png)

## 关键问题

**运行过程中，客户端连不上注册中心怎么办？**

可能是网络问题、注册中心崩溃等

从一致性的角度考虑，客户端立即终止服务调用，直到与注册中心恢复连接

从可用性的角度考虑，客户端继续服务，并尝试重新连接注册中心，这段时间使用缓存数据。一段时间连接不上后，再终止服务

**运行过程中，客户端拿到了注册数据，但是连不上对应的服务端怎么办？**

可能是因为客户端和服务端中有防火墙，当服务端连接不上时，客户端需要从本地的可用节点列表中移除相应的服务实例；等服务恢复后，再加入节点列表中

**注册中心崩溃了，客户端和服务端怎么办？**

这个问题相当于客户端连接不上注册中心，详见问题1：**运行过程中，客户端连不上注册中心怎么办？**

**服务端崩溃之后，客户端多久才能知道？**

取决于服务端和注册中心的交互方式：

若是服务端主动续约，没有心跳的情况：取决于租约超时时间和注册中心租约超时重试机制

若是注册中心主动与服务端保持心跳的情况：取决于心跳重试的次数和间隔

**容器内部 IP 问题**

在示例的etcd中是使用ip+端口来识别服务实例的。若微服务运行在docker容器中，那ip永远是localhost.

解决方案：

1. 使用容器专属服务注册与发现方式
2. 容器启动时使用宿主机网路，而不是创建虚拟网络
3. 容器启动时将宿主机ip作为环境变量注入

**服务端和注册中心连不上了怎么办？**

服务端重试，直到连上，输出错误日志。一般来说，服务端不会因为和注册中心连接不上就停止服务。注册中心连接不上服务端会进行重试，若多次重试连接不上，就认为服务端挂了，通知客户端
